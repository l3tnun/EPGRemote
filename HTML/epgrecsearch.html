<!DOCTYPE html>
<html>
<head>
    <title>番組検索</title>
    <meta name="viewport" content="width=device-width, user-scalable=no,">
    <meta charset="utf-8">
    <link rel="stylesheet" href="/jquery/jquery.mobile.min.css" />
    <link rel="stylesheet" href="/jquery.growl/css/jquery.growl.css" />
    <link rel="stylesheet" href="/css/topbutton.css" />
    <script src="/jquery/jquery.min.js"></script>
    <script src="/jquery/jquery.mobile.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/jquery.growl/js/jquery.growl.js"></script>
    <script src="/js/new_socketio.js"></script>
    <script src="/js/reconnect_socketio.js"></script>
    <script src="/js/epgrec_search_command.js"></script>
</head>
<script>
function scrollTopButton() {
    $('html,body').animate({ scrollTop: 0 }, 'swing');
}

function scrollTopButton() {
    $('html,body').animate({ scrollTop: 0 }, 'swing');
}

var genrus = {}, subGenrus, stations = {}, recModeDefaultId;
var socketid = `${new Date().getTime()}:${Math.random().toString(36).slice(-8)}`;
$(function () {
    socketio.emit("getEPGRecSearchSetting", socketid);

    socketio.on("resultEPGRecSearchSetting", function(data) {
        if(socketid != data.socketid) { return; }

        data.genrus.forEach(function(genru) {
            genrus[genru.id] = genru.name_jp
            $("#genre").append($('<option>').html(`${genru.name_jp}`).val(`${genru.id}`));
            $("#rec_genre").append($('<option>').html(`${genru.name_jp}`).val(`${genru.id}`));
        });

        data.channel.forEach(function(channel) {
            stations[channel.channel_disc] = channel.sid;
            $("#station").append($('<option>').html(`${channel.name}`).val(`${channel.id}`));
        });

        data.recMode.forEach(function(mode) {
            $("#rec_mode").append($('<option>').html(`${mode.name}`).val(`${mode.id}`));
        });

        recModeDefaultId = data.recModeDefaultId;
        subGenrus = data.subGenrus;

    });
});

$(function($) {
    //ジャンルが変更された時にサブジャンルを書き換える
    $('#genre').change(function() {
        $('#sub_genre').empty();
        $('#sub_genre').append($('<option>').html("すべて").val("16"));
        var i = 0;
        subGenrus[$('#genre option:selected').val() - 1].forEach(function(sub) {
            $('#sub_genre').append($('<option>').html(sub).val('"' + i + '"'));
        });
    });

    //Enter キーが押された時
    $('#search').keypress(function(key) {
        if(key.which == 13) {
            getEPGRecSearchResult();
            $('#search').blur();
            return false;
        }
    });
});

function checkedSearchOption() {
    //検索語句
    if(!$("#use_regexp").prop('checked') && !$("#collate_ci").prop('checked') && !$("#enable_title").prop('checked') && !$("#enable_disc").prop('checked') || $("#collate_ci").prop('checked')) {
        $("#enable_title").prop('checked', true);
        $("#enable_disc").prop('checked', true);
    } else if($("#use_regexp").prop('checked')) {
        $("#collate_ci").prop('checked', false)
    }

    //曜日
    if(!$("#week0").prop('checked') && !$("#week1").prop('checked') && !$("#week2").prop('checked') && !$("#week3").prop('checked') && !$("#week4").prop('checked') && !$("#week5").prop('checked') && !$("#week6").prop('checked')) {
        $("#week0").prop('checked', true);
        $("#week1").prop('checked', true);
        $("#week2").prop('checked', true);
        $("#week3").prop('checked', true);
        $("#week4").prop('checked', true);
        $("#week5").prop('checked', true);
        $("#week6").prop('checked', true);
    }

    //放送波
    if(!$("#type_gr").prop('checked') && !$("#type_bs").prop('checked') && !$("#type_cs").prop('checked') && !$("#type_ex").prop('checked') ) {
        $("#type_gr").prop('checked', true);
        $("#type_bs").prop('checked', true);
        $("#type_cs").prop('checked', true);
        $("#type_ex").prop('checked', true);
    }
}

function getEPGRecSearchResult() {
    if($("#search").val() == "") {
        $.growl.error({ message: "検索語句が入力されていません" });
        return;
    }

    checkedSearchOption();

    var option  = {
            do_search: "1",
            search: $("#search").val(),
            station: $("#station").val(),
            category_id: $("#genre").val(),
            sub_genre: $("#sub_genre").val(),
            prgtime: $("#prgtime").val(),
            period: $("#period").val()
    };

    if($("#use_regexp").prop('checked')) { option.use_regexp = "1"; }
    if($("#collate_ci").prop('checked')) { option.collate_ci = "1"; }
    if($("#enable_title").prop('checked')) { option.enable_title = "1"; }
    if($("#enable_disc").prop('checked')) { option.enable_disc = "1"; }
    if($("#type_gr").prop('checked')) { option.typeGR = "1"; }
    if($("#type_bs").prop('checked')) { option.typeBS = "1"; }
    if($("#type_cs").prop('checked')) { option.typeCS = "1"; }
    if($("#type_ex").prop('checked')) { option.typeEX = "1"; }
    if($("#week0").prop('checked')) { option.week0 = "1"; }
    if($("#week1").prop('checked')) { option.week1 = "1"; }
    if($("#week2").prop('checked')) { option.week2 = "1"; }
    if($("#week3").prop('checked')) { option.week3 = "1"; }
    if($("#week4").prop('checked')) { option.week4 = "1"; }
    if($("#week5").prop('checked')) { option.week5 = "1"; }
    if($("#week6").prop('checked')) { option.week6 = "1"; }
    if($("#first_genre").prop('checked')) { option.first_genre = "1"; }

    socketio.emit("getEPGRecSearch", socketid, option);
}

//検索結果の取得
var searchResult, searchResultKeyId;
socketio.on("resultEPGRecSearchResult", function(data) {
    if(socketid != data.socketid) { return; }

    searchResult = data.json;
    searchResultKeyId = {};

    //search_listview
    var liStr = ""
    data.json.forEach(function(program) {
        if(program.station_name == 1) { return; }

        searchResultKeyId[program.id] = program;

        var classStr = 'class="';
        if(program.rec == 1) { classStr += 'recorded '; }
        if(program.autorec == 0) { classStr += 'freeze '; }
        classStr += '"';

        liStr += `<li><a id="prgID_${program.id}" ${classStr} href="javascript:openInfoDialog(${program.id})" target="_self"">`
        liStr += `<h3 class="wordbreak">${program.title}</h3>`;
        liStr += `<p>${program.type}:${program.station_name_str}</p>`;
        liStr += `<p class="wordbreak">${program.date} ${program.starttime}${program.endtime}(${program.duration})</p>`;
        liStr += `<p class="wordbreak">${program.description}</p>`;
        liStr += `</a></li>\n`;
    });

    $("#search_listview").empty();
    $("#search_listview").append(liStr);
    $("#search_listview").listview('refresh');

    $('html,body').animate({ scrollTop: $("#search_listview").offset().top }, 'swing');
    if(Object.keys(searchResultKeyId).length == 0){
        $.growl.error({ message: "検索結果がありません" });
    } else {
        $.growl({ title: '' , message: Object.keys(searchResultKeyId).length + "件ヒットしました" });
    }
});

var programId;
function openInfoDialog(id) {
    console.log(searchResultKeyId[id]);
    $("#programDialogTitle").text(searchResultKeyId[id].title);
    $("#programDialogChannelName").text(searchResultKeyId[id].station_name_str);
    $("#programDialogTime").text(`${searchResultKeyId[id].date} ${searchResultKeyId[id].starttime}${searchResultKeyId[id].endtime}(${searchResultKeyId[id].duration})`);
    $("#programDialogDescription").text(searchResultKeyId[id].description);

    if(searchResultKeyId[id].rec == 0) {
        $("#reced_buton").hide();
        $("#no_reced_button").show();
    } else {
        $("#reced_buton").show();
        $("#no_reced_button").hide();
    }

    if(searchResultKeyId[id].autorec == 1) {
        $("#no_reced_autorec").text("自動禁止");
        $("#reced_autorec").text("自動禁止");
    } else {
        $("#no_reced_autorec").text("自動許可");
        $("#reced_autorec").text("自動許可");
    }

    programId = id;
    $("#infoDialog").popup('open');
}

function getTimeValue(topStr, time) {
    var array = time.split(":");
    var year = Number(topStr.substr(0, 4));
    var month = Number(topStr.substr(4, 2));
    var day = Number(topStr.substr(6, 2));
    return { year: year, month: month, day: day, hour: Number(array[0]), minute: Number(array[1]), second: Number(array[2]) }
}

function setDetailDialog() {
    station = searchResultKeyId[programId];
    var startTime = getTimeValue(station.prg_top, station.starttime.slice(0, -1));
    var endTime = getTimeValue(station.prg_top, station.endtime);

    $("#detail_rec_start_year").val(startTime.year);
    $("#detail_rec_start_month").val(startTime.month);
    $("#detail_rec_start_day").val(startTime.day);
    $("#detail_rec_start_hour").val(startTime.hour);
    $("#detail_rec_start_minute").val(startTime.minute);
    $("#detail_rec_start_second").val(startTime.second);

    $("#detail_rec_end_year").val(endTime.year);
    $("#detail_rec_end_month").val(endTime.month);
    $("#detail_rec_end_day").val(endTime.day);
    $("#detail_rec_end_hour").val(endTime.hour);
    $("#detail_rec_end_minute").val(endTime.minute);
    $("#detail_rec_end_second").val(endTime.second);

    $("#detail_program_id_checkbox").prop("checked", true);
    $("#detail_rec_delete_file").prop("checked", false);
    $("#detail_rec_discontinuity").prop("checked", false);

    $("#rec_genre").val(station.genre_id);
    $("#rec_genre").selectmenu('refresh',true);

    $("#rec_mode").val(recModeDefaultId);
    $("#rec_mode").selectmenu('refresh',true);

    $('#detail_rec_station_name').text(station.type + ":" + station.station_name_str)
    $('#detail_rec_title').val(station.title);
    $('#detail_rec_description').val(station.description);
    $('#detail_channel_id').text(station.channel_id);
}

var detailDialogLeftPosition = -1;
var detailDialogHeight = -1;
function openDetailRecDialog() {
    setDetailDialog();
    $("#infoDialog").popup('close');
    if(detailDialogHeight != -1) {
        $("#detailRecDialog-popup").height(detailDialogHeight);
    }
    $("#detailRecDialog").popup('open');
    if($(window).width() < 450) {
        $("#detailRecDialog").css("transform", "scale(" + $(window).width() / 450 + ")");
        if(detailDialogLeftPosition == -1) {
            detailDialogLeftPosition = $("#detailRecDialog").offset().left - 8;
            detailDialogHeight = $("#detailRecDialog-popup").height();
        }
        $("#detailRecDialog").css("left", "-" + detailDialogLeftPosition + "px");
        $("#detailRecDialog-popup").height(0);
    } else {
        $("#detailRecDialog").css("transform", "scale(1.0)");
    }

    console.log($("#detailRecDialog").offset());
}

</script>
<style>
.inline label{
  display: inline-block;
}

input[type="checkbox"] {
    -webkit-transform: scale(1.2);
    transform: scale(1.2);
    margin-right: 3px;
}

select {
    -webkit-appearance: button;
    -moz-appearance: button;
    appearance: button;
    width: 100%;
    background:#EEE;
    background-size:20px 10px;
    background-position: right center;
    height: 40px;
    line-height: 40px;
    font-size: 15px;
    vertical-align: middle;
    border:1px solid #CCC;
    margin-bottom:5px;
}

.ui-listview .wordbreak {
    overflow: visible;
    white-space: normal;
}

.ui-listview > li > a.ui-btn:active.recorded, .ui-listview > li > a.ui-btn.recorded {
    background: #F55 !important;
    color: #FEE !important;
    text-shadow: none;
}

.ui-listview > li > a.ui-btn:active.freeze, .ui-listview > li > a.ui-btn.freeze {
    background: #AAA;
    color: black;
    text-shadow: none;
}

.ui-page-theme-a .ui-body-inherit {
    text-shadow: none;
}

.infoDialogButton {
    background: #0078AE none repeat scroll 0% 0%;
    color: white;
    text-shadow: none;
    padding: 11px 10px;
    text-align: center;
    line-height: 36px;
    margin: 0px 2px;
    font-size: 14px;
    text-decoration: none;
}

.infoDialogCancelButton {
    background: #0078AE none repeat scroll 0% 0%;
    color: #FFF;
    text-shadow: none;
    padding: 11px 22px;
    text-align: center;
    line-height: 36px;
    margin: 0px 10px;
    font-size: 16px;
    text-decoration: none;
}

.ui-page-theme-a a, html .ui-body-a a, .ui-page-theme-a a:hover, html .ui-body-a a:hover, .ui-page-theme-a a:active, html .ui-body-a a:active {
    color: white;
}

<!--予約詳細-->
#detail_rec_station_name {
    text-align: left;
    color: #444;
    font-size: 1.2em;
}

.detail_time > span {
    margin-top: 18px;
    padding-right: 3px;
}

.detail_time > .ui-input-text > input{
    height:38px;
    width: 30px;
}

.detaile_rec_button {
    display: block;
    background: #0078AE none repeat scroll 0% 0%;
    text-decoration: none;
    width: 110px;
    text-align: center;
    padding: 14px 4px;
    margin: 0 auto;
    font-size: 18px;
}

.ui-select {
    width: 200px;
}

</style>
<body>
<!--topにスクロールするボタン-->
<a class="scroll_top_button" style="color: white;" herf="#" onclick="javascript:scrollTopButton()">▲</a>

<!--番組情報ダイアログ-->
<div data-role="popup" id="infoDialog" data-overlay-theme="b" data-theme="a" data-history="false" class="ui-content" style="width: 260px;">
    <a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-a ui-icon-delete ui-btn-icon-notext ui-btn-right">close</a>
    <p id="programDialogTitle" style="font-weight: bold;">title</p>
    <p id="programDialogChannelName" style="font-size: 13px;">channel name</p>
    <p id="programDialogTime" style="font-size: 13px;">time</p>
    <p id="programDialogDescription">description</p>

    <div id="no_reced_button" class="ui-grid-b">
        <div class="ui-block-a"><a href="javascript:openDetailRecDialog()" class="infoDialogButton">詳細予約</a></div>
        <div class="ui-block-b"><a href="javascript:rec()" class="infoDialogButton">簡易予約</a></div>
        <div class="ui-block-c"><a id="no_reced_autorec" href="javascript:toggleAutoRec()" class="infoDialogButton">自動禁止</a></div>
    </div>

    <div id="reced_buton" class="ui-grid-a">
        <div class="ui-block-a"><a href="javascript:cancelRec()" class="infoDialogCancelButton">予約削除</a></div>
        <div class="ui-block-b"><a id="reced_autorec" href="javascript:toggleAutoRec()" class="infoDialogCancelButton">自動禁止</a></div>
    </div>
</div>

<!-- 詳細予約ダイアログ-->
<div data-role="popup" id="detailRecDialog" data-overlay-theme="b" data-theme="a" data-history="false" class="ui-content" style="width:400px; height: auto;">
    <a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-a ui-icon-delete ui-btn-icon-notext ui-btn-right">close</a>

    <div style="display:inline-flex" class="detail_time">
        <span>開始時刻</span>
        <input style="width:50px;" id="detail_rec_start_year" type="number" size="4" min=2016 max=2100/>
        <span>年</span>
        <input id="detail_rec_start_month" type="number" size="2" min=1 max=12/>
        <span>月</span>
        <input id="detail_rec_start_day" type="number" size="2" min=1 max=31/>
        <span>日</span>
        <input id="detail_rec_start_hour" type="number" size="2" min=0 max=23/>
        <span>時</span>
        <input id="detail_rec_start_minute" type="number" size="2" min=0 max=59/>
        <span>分</span>
        <input id="detail_rec_start_second" type="number" size="2" min=0 max=59/>
        <span>秒</span>
    </div>

    <div style="display:inline-flex" class="detail_time">
        <span>終了時刻</span>
        <input style="width:50px;" id="detail_rec_end_year" type="number" size="4" min=2016 max=2100/>
        <span>年</span>
        <input id="detail_rec_end_month" type="number" size="2" min=1 max=12/>
        <span>月</span>
        <input id="detail_rec_end_day" type="number" size="2" min=1 max=31/>
        <span>日</span>
        <input id="detail_rec_end_hour" type="number" size="2" min=0 max=23/>
        <span>時</span>
        <input id="detail_rec_end_minute" type="number" size="2" min=0 max=59/>
        <span>分</span>
        <input id="detail_rec_end_second" type="number" size="2" min=0 max=59/>
        <span>秒</span>
    </div>

    <div style="display:inline-flex" class="detail_time">
        <span style="padding-right: 10px;">優先度</span>
        <input id="detail_rec_priority" type="number" value="10"/>
        <span style="padding-left: 10px;">ID保持</span>
        <input id="detail_program_id_checkbox" type="checkbox" checked="checked"></input>
        <span style="padding-left: 40px;">ts削除</span>
        <input id="detail_rec_delete_file" type="checkbox"></input>
        <span style="padding-left: 40px;">隣接禁止</span>
        <input id="detail_rec_discontinuity" type="checkbox"></input>
    </div>

    <div style="display:inline-flex" class="detail_time">
        <select id="rec_mode" style="padding-left: 10px;" name="rec_mode">
        </select>

        <select id="rec_genre" style="padding-left: 10px;" name="rec_genre">
        </select>
    </div>

    <div id="detail_rec_station_name">station_name</div>

    <textarea id="detail_rec_title" name="description" rows="3" cols="48"></textarea>
    <textarea id="detail_rec_description" name="title" rows="3" cols="48"></textarea>

    <a href="javascript:customRec();" target="_self" class="detaile_rec_button" style="color: white;">予約する</a>

    <p id="detail_channel_id" style="display: none;">channel_id</p>
</div>

<div data-role="header">
    <a href="/epgrec">BACK</a>
    <h1>番組検索</h1>
</div>
<div role="main" class="ui-content">
    <div class="inline" style="margin: -10px 0px;">
        <label data-role="none" style="font-size: 14px;">
        <input data-role="none" id="use_regexp" type="checkbox"/>正規表現</label>
        <label data-role="none" style="font-size: 14px;">
        <input data-role="none" id="collate_ci" type="checkbox"/>全半角</label>
        <label data-role="none" style="font-size: 14px;">
        <input data-role="none" id="enable_title" type="checkbox"/>タイトル</label>
        <label data-role="none" style="font-size: 14px;">
        <input data-role="none" id="enable_disc" type="checkbox"/>概要</label>
    </div>

    <input id="search" name="search" type="text" data-clear-btn="true"/>

    <div class="inline" style="margin: -2px 0px;">
        <label data-role="none"><input data-role="none" id="type_gr" type="checkbox"/>GR</label>
        <label data-role="none"><input data-role="none" id="type_bs" type="checkbox"/>BS</label>
        <label data-role="none"><input data-role="none" id="type_cs" type="checkbox"/>CS</label>
        <label data-role="none"><input data-role="none" id="type_ex" type="checkbox"/>EX</label>
    </div>

    <div class="inline" style="margin: 3px 0px;">
        <label data-role="none"><input data-role="none" id="week0" type="checkbox"/>月</label>
        <label data-role="none"><input data-role="none" id="week1" type="checkbox"/>火</label>
        <label data-role="none"><input data-role="none" id="week2" type="checkbox"/>水</label>
        <label data-role="none"><input data-role="none" id="week3" type="checkbox"/>木</label>
        <label data-role="none"><input data-role="none" id="week4" type="checkbox"/>金</label>
        <label data-role="none"><input data-role="none" id="week5" type="checkbox"/>土</label>
        <label data-role="none"><input data-role="none" id="week6" type="checkbox"/>日</label>
    </div>


    <div class="inline" style="margin: 3px 0px;">
    <label data-role="none">放送局</label>
    <select data-role="none" id="station">
        <option value="0">すべて</option>
    </select>
    </div>


    <div class="inline" style="margin: 3px 0px;">
    <div class="ui-grid-a">
        <div class="ui-block-a">
            <label data-role="none">ジャンル
            <input data-role="none" id="first_genre" type="checkbox"/> 全保持</label>
            <select data-role="none" id="genre">
                <option value="0">すべて</option>
            </select>
        </div>

        <div class="ui-block-b">
            <label data-role="none">サブジャンル<input data-role="none" type="checkbox" style="visibility: hidden;"/></label>
            <select data-role="none" id="sub_genre">
                <option value="16">すべて</option>
            </select>
        </div>
    </div>

    <div class="inline" style="margin: 3px 0px;">
    <label data-role="none">
    <select data-role="none" id="prgtime" name="prgtime" style="width:auto;">
        <option value="0">0時</option>
        <option value="1">1時</option>
        <option value="2">2時</option>
        <option value="3">3時</option>
        <option value="4">4時</option>
        <option value="5">5時</option>
        <option value="6">6時</option>
        <option value="7">7時</option>
        <option value="8">8時</option>
        <option value="9">9時</option>
        <option value="10">10時</option>
        <option value="11">11時</option>
        <option value="12">12時</option>
        <option value="13">13時</option>
        <option value="14">14時</option>
        <option value="15">15時</option>
        <option value="16">16時</option>
        <option value="17">17時</option>
        <option value="18">18時</option>
        <option value="19">19時</option>
        <option value="20">20時</option>
        <option value="21">21時</option>
        <option value="22">22時</option>
        <option value="23">23時</option>
        <option selected="" value="24">なし</option>
    </select>
    時から
    <select data-role="none" id="period" name="period" style="width:auto;">
        <option value="1" selected="">1時間</option>
        <option value="2">2時間</option>
        <option value="3">3時間</option>
        <option value="4">4時間</option>
        <option value="5">5時間</option>
        <option value="6">6時間</option>
        <option value="7">7時間</option>
        <option value="8">8時間</option>
        <option value="9">9時間</option>
        <option value="10">10時間</option>
        <option value="11">11時間</option>
        <option value="12">12時間</option>
        <option value="13">13時間</option>
        <option value="14">14時間</option>
        <option value="15">15時間</option>
        <option value="16">16時間</option>
        <option value="17">17時間</option>
        <option value="18">18時間</option>
        <option value="19">19時間</option>
        <option value="20">20時間</option>
        <option value="21">21時間</option>
        <option value="22">22時間</option>
        <option value="23">23時間</option>
    </select>
    </label>
    </div>

    <a href="javascript:getEPGRecSearchResult()" class="ui-btn" style="margin-bottom: 35px;">検索</a>


</div>

    <ul id = "search_listview" data-role="listview">
    </ul>

</body>
</html>
